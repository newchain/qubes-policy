## <summary>qubes-core-agent policy</summary>
## <desc>
##	<p>
##		Policy for qubes-core-agent (RPC backdoor) and related
##		utilities.
##	</p>
## </desc>


###############################
## <summary>
##	Send sigchld to qrexec-agent_su_t.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit sigchld.
##	</summary>
## </param>

interface(`qrexec-agent_su_child',`

	gen_require(`

		type qrexec-agent_su_t;
	')

	allow $1 qrexec-agent_su_t : process sigchld;
')


###############################
## <summary>
##	Run qrexec-client-vm in qrexec-client-vm_t
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit transition.
##	</summary>
## </param>

interface(`qrexec_client_vm_domtrans',`

	gen_require(`

		type qrexec-client-vm_t;
		type qrexec-client-vm_exec_t;
	')

	domtrans_pattern($1, qrexec-client-vm_exec_t, qrexec-client-vm_t)
')


###############################
## <summary>
##	Bluepill appvm by hiding locale.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to suppress audit logs.
##	</summary>
## </param>

interface(`qubes_bluepill_locale',`

	gen_require(`

		type locale_t;
	')

	tunable_policy(`qubes_bluepill_timezone',`

		dontaudit $1 locale_t : dir search;

		# (localtime)
		#
		dontaudit $1 locale_t : file read;
	')

	tunable_policy(! `qubes_bluepill_timezone',`

		miscfiles_read_localization($1)
	')
')


###############################
## <summary>
##	Search Qubes RPC config dir.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit search.
##	</summary>
## </param>

interface(`qubes_search_rpc_etc',`

	gen_require(`

		type qubes_rpc_etc_t;
	')

	allow $1 qubes_rpc_etc_t : dir search;
')


###############################
## <summary>
##	getattr Qubes RPC config files.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit getattr.
##	</summary>
## </param>

interface(`qubes_getattr_rpc_etc',`

	gen_require(`
		
		type qubes_rpc_etc_t;
	')

	allow $1 qubes_rpc_etc_t : file getattr;
')


###############################
## <summary>
##	Read and open Qubes RPC config files.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit read.
##	</summary>
## </param>

interface(`qubes_read_rpc_etc',`

	gen_require(`

		type qubes_rpc_etc_t;
	')

	allow $1 qubes_rpc_etc_t : file { read open };
')

###############################
## <summary>
##	Search qubes_rpc_worker
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit search.
##	</summary>
## </param>

interface(`qubes_search_rpc_worker_exec',`

	gen_require(`

		type qubes_rpc_worker_exec_t;
	')

	allow $1 qubes_rpc_worker_exec_t : dir search_dir_perms;
')


###############################
## <summary>
##	Search QubesIncoming.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit search.
##	</summary>
## </param>

interface(`qubes_search_shared_home',`

	gen_require(`

		type qubes_shared_home_t;
	')

	userdom_search_user_home_dirs($1)

	allow $1 qubes_shared_home_t : dir search_dir_perms;
')


###############################
## <summary>
##	List QubesIncoming.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit list.
##	</summary>
## </param>

interface(`qubes_list_shared_home',`

	qubes_search_shared_home($1)

	allow $1 qubes_shared_home_t : dir read;
')


###############################
## <summary>
##	getattr QubesIncoming files
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit getattr.
##	</summary>
## </param>

interface(`qubes_getattr_shared_home_files',`

	qubes_search_shared_home($1)

	allow $1 qubes_shared_home_t : file getattr_file_perms;
')


###############################
## <summary>
##	Read QubesIncoming files
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit read.
##	</summary>
## </param>

interface(`qubes_read_shared_home',`

	qubes_search_shared_home($1)

	allow $1 qubes_shared_home_t : file read_file_perms;
')


###############################
## <summary>
##	Write to qubes-rpc stderror fifo.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit write.
##	</summary>
## </param>

interface(`qubes_write_rpc_stderror',`

	gen_require(`

		type qubes_rpc_stderror_t;
	')

	allow $1 qubes_rpc_stderror_t : fifo_file write;
')


###############################
## <summary>
##	Write to qubes-rpc stderror fifo inherited from qrexec-multiplexer.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit write.
##	</summary>
## </param>

interface(`qubes_write_inherited_rpc_stderror',`

	gen_require(`

		type qubes_rpc_stderror_t;
	')

	qubes_use_rpc_multiplexer_fds($1)

	allow $1 qubes_rpc_stderror_t : fifo_file write;
')


###############################
## <summary>
##	Inherit qrexec-agent fds
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit inheritance.
##	</summary>
## </param>

interface(`qubes_use_qrexec_agent_fds',`

	gen_require(`

		type qrexec-agent_t;
	')

	allow $1 qrexec-agent_t : fd use;
')


###############################
## <summary>
##	Write to qrexec-agent pipes.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit write.
##	</summary>
## </param>

interface(`qubes_write_qrexec_agent_pipes',`

	gen_require(`

		type qrexec-agent_t;
	')

	allow $1 qrexec-agent_t : fifo_file write;
')


###############################
## <summary>
##	Read and write to qrexec-agent pipes.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit read and write.
##	</summary>
## </param>

interface(`qubes_rw_qrexec_agent_pipes',`

	qubes_write_qrexec_agent_pipes($1)

	allow $1 qrexec-agent_t : fifo_file read;
')


###############################
## <summary>
##	Read and write to inherited qrexec-agent pipes.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit read and write.
##	</summary>
## </param>

interface(`qubes_rw_inherited_qrexec_agent_pipes',`

	qubes_use_qrexec_agent_fds($1)
	qubes_write_qrexec_agent_pipes($1)

	allow $1 qrexec-agent_t : fifo_file read;
')


###############################
## <summary>
##	Inherit qubes-rpc-multiplexer fds.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit inheritance.
##	</summary>
## </param>

interface(`qubes_use_rpc_multiplexer_fds',`

	gen_require(`

		type qubes-rpc-multiplexer_t;
	')

	allow $1 qubes-rpc-multiplexer_t : fd use;
')


###############################
## <summary>
##	Transition to qubes-trigger-sync-appmenus_t
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit transition from.
##	</summary>
## </param>

interface(`qubes_trigger_sync_appmenus_transition_pattern',`

	gen_require(`
		type qubes-trigger-sync-appmenus_t;
		type qubes-trigger-sync-appmenus_exec_t;
	')

	domtrans_pattern($1, qubes-trigger-sync-appmenus_exec_t, qubes-trigger-sync-appmenus_t)
')


###############################
## <summary>
##	Permit role to sync app menus.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit transition from.
##	</summary>
## </param>
## <param name="role">
##	<summary>
##		Role to assign types.
##	</summary>
## </param>

interface(`qubes_trigger_sync_appmenus_role',`

	gen_require(`
		type qubes-trigger-sync-appmenus_worker_t;
	')

	qubes_trigger_sync_appmenus_transition_pattern($1)

	role $2 types { qubes-trigger-sync-appmenus_t qubes-trigger-sync-appmenus_worker_t };

')


###############################
## <summary>
##	Transition to qvm domains.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit transition from.
##	</summary>
## </param>

interface(`qvm_domain_transition_pattern',`

	gen_require(`
		type qubes_shared_home_t;
		type qvm_t;
		type qvm-copy-to-vm_t;
		type qvm-copy-to-vm_exec_t;
		type qvm_exec_t;
	')

	domtrans_pattern($1, qvm_exec_t, qvm_t)
	domtrans_pattern($1, qvm-copy-to-vm_exec_t, qvm-copy-to-vm_t)

	list_dirs_pattern($1, qubes_shared_home_t, qubes_shared_home_t)
')


###############################
## <summary>
##	Permit role to use qvm utilities.
## </summary>
## <param name="domain">
##	<summary>
##		Domain to permit transition from.
##	</summary>
## </param>
## <param name="role">
##	<summary>
##		Role to assign types.
##	</summary>
## </param>

interface(`qvm_role',`

	gen_require(`

		type qfile-agent_t;
		type qrexec-client-vm_t;
		type qvm-copy-to-vm_worker_t;
	')

	qvm_domain_transition_pattern($1)

	role $2 types { qfile-agent_t qrexec-client-vm_t qvm_t qvm-copy-to-vm_t qvm-copy-to-vm_worker_t };

	allow qfile-agent_t $1 : process sigchld;
	allow qrexec-client-vm_t $1 : process sigchld;
')
